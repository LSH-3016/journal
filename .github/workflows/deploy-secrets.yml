name: Deploy Secrets to EKS

on:
  workflow_dispatch:
    inputs:
      db_password:
        description: 'Database Password'
        required: true
        type: string
      aws_access_key:
        description: 'AWS Access Key ID'
        required: true
        type: string
      aws_secret_key:
        description: 'AWS Secret Access Key'
        required: true
        type: string

env:
  AWS_REGION: us-east-1
  EKS_CLUSTER_NAME: fproject-dev-eks

jobs:
  deploy-secrets:
    name: Deploy Kubernetes Secrets
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Install kubectl
      uses: azure/setup-kubectl@v3
      with:
        version: 'v1.28.0'

    - name: Update kube config
      run: |
        aws eks update-kubeconfig --name $EKS_CLUSTER_NAME --region $AWS_REGION
        kubectl version --client
        kubectl cluster-info

    - name: Check EKS Access
      run: |
        echo "Testing EKS access..."
        kubectl auth can-i get pods --all-namespaces || echo "Limited access, but continuing..."

    - name: Create Kubernetes Secret
      run: |
        # Secret이 이미 있으면 삭제
        kubectl delete secret journal-secrets --ignore-not-found=true
        
        # 새로운 Secret 생성
        kubectl create secret generic journal-secrets \
          --from-literal=db-host="fproject-dev-postgres.c9eksq6cmh3c.us-east-1.rds.amazonaws.com" \
          --from-literal=db-port="5432" \
          --from-literal=db-name="fproject_db" \
          --from-literal=db-user="fproject_user" \
          --from-literal=db-password="${{ github.event.inputs.db_password }}" \
          --from-literal=aws-access-key-id="${{ github.event.inputs.aws_access_key }}" \
          --from-literal=aws-secret-access-key="${{ github.event.inputs.aws_secret_key }}" \
          --from-literal=bedrock-flow-arn="arn:aws:bedrock:us-east-1:324547056370:flow/YSIQGU4YIR" \
          --from-literal=bedrock-flow-alias="QL17D7C34Z"

    - name: Verify Secret
      run: |
        kubectl get secret journal-secrets
        echo "✅ Secret 배포 완료!"
